---
title: "background"
format: html
---

I started off by trying to see if I could make a presentation related to the "Down 8" test in the NFL. The test refers to when a team is losing by 14, but then scores a touchdown. Now down 8, the coach has a decision to make. Does he kick the extra point or does he go for 2? Many people's first inclination and the easy answer is to kick the extra point - why risk missing the 2 point conversion just to have to do it again later. ESPN's Seth Walder researched the data and ran tests. For the vast majority of the time, a team's chance to win the game going for 2 when down 8 is higher than if they kick the extra point, regardless if they convert or not. Now, a lot does hinge on that data, but it's mathematically sound. 

Link to the article: https://www.espn.com/nfl/story/_/id/28100383/going-2-8-points-why-nfl-teams-keep-doing-why-analytics-backs-up

Although I wanted to do something with this, there were too many factors and two small a data set to make a compelling presentation. So, I pivoted to just fourth downs. Within the past 5 years or so, NFL teams have been going for it on 4th down more frequently, with the reasoning of "it's what the analytics say to do." Those "analytics" are typically a team's winning percentage if they choose to go for it or if they choose to punt. 

I decided to look at that in two conexts: going for it anytime, and going for it in crunch time, which I defined as the team with possession is losing with less than 5 minutes to go in the 4th quarter. 

Some of that initial data:

```{r}
season <- 2024

pbp <- load_pbp(2024)

fourth_down_pbp <- pbp |> 
filter(down == 4, play_type %in% c("run", "pass"), yards_gained > ydstogo) |> 
mutate(fourth_down_successful = yards_gained > ydstogo)

fourth_down_pbp |> 
group_by(posteam) |> 
summarise(epa)
```

```{r}
fit <- lm(fourth_down_successful ~ epa, data = fourth_down_pbp)
summary(fit)
```

```{r}
clutch_time <- fourth_down_pbp |> 
filter(qtr == 4, game_seconds_remaining < 300, posteam_score < defteam_score)

fit <- lm(fourth_down_successful ~ epa, data = clutch_time) 
summary(fit)
```

A good start, but as we've established, I shouldn't have filtered out successful conversions. 

## FIRST PRESENTATION REFINING

```{r}
fourth_down_attempts <- fourth_down_pbp |> 
group_by(posteam) |> 
  summarise(plays = n(), total_epa = sum(epa)) |> 
  arrange(desc(total_epa))
```
```{r}
ggplot() + geom_point(data = fourth_down_attempts, aes(x=plays, y=total_epa)) +
geom_smooth(data = fourth_down_attempts, aes(x=plays, y=total_epa), method = lm)
```

```{r}
fourth_q_fourth_downs_epa <- clutch_time |> 
group_by(posteam) |> 
  summarise(plays = n(), total_epa = sum(epa)) |>
  arrange(desc(total_epa))
```

```{r}
fourth_q_fourth_downs_wpbefore <- clutch_time |> 
group_by(posteam) |> 
  summarise(plays = n(), wp_before = sum(wp)) |> 
  arrange(desc(wp_before))
```

```{r}
fourth_q_fourth_downs_wpafter <- clutch_time |> 
group_by(posteam) |> 
  summarise(plays = n(), wp_after = sum(wpa)) |> 
  arrange(desc(wp_after))
```

```{r}
bears_results_away <- clutch_time |> 
filter(posteam == "CHI", away_team == "CHI") |> 
group_by(posteam) |>
  summarise(Bears = total_away_score, Opponent = total_home_score)

bears_results_home <- clutch_time |> 
filter(posteam == "CHI", home_team == "CHI") |> 
group_by(posteam) |> 
  summarise(Bears = total_home_score, Opponent = total_away_score)

bears_results_total <- bind_rows(bears_results_away, bears_results_home)
```

```{r}
fourth_down_totals <- pbp |> 
filter(down == 4, play_type %in% c("run", "pass")) |> 
group_by(posteam) |> 
  summarise(fourth_downs = n()) |> 
  arrange(desc(fourth_downs))

fourth_down_successful <- fourth_down_pbp |> 
group_by(posteam) |> 
  summarize(fourth_down_conversions = n()) |> 
  arrange(desc(fourth_down_conversions))

combined_fourth_downs <- fourth_down_totals |> 
inner_join(fourth_down_successful, join_by(posteam)) |>
mutate(fourth_down_pct = fourth_down_conversions/fourth_downs *100) |> 
  arrange(desc(fourth_down_pct))

fourth_down_epa <- fourth_down_pbp |> 
group_by(posteam) |> 
  summarise(total_epa = sum(epa)) |> 
  arrange(desc(total_epa))

fourth_down_epa_plus_conversion <- combined_fourth_downs |> 
inner_join(fourth_down_epa, join_by(posteam))
```

```{r}
install.packages("nflverse")
library(nflverse)
install.packages("dyplr")
library(dplyr)
```

```{r}
games_2024 <- nflreadr::load_schedules(2024)

standings_2024 <- nflseedR::nfl_standings(games_2024)

wins_2024 <- standings_2024 |> 
group_by(team) |> 
summarise(total_wins = wins)

colnames(wins_2024)[colnames(wins_2024) == "team"] <- "posteam"

final_chart <- wins_2024 |> 
inner_join(fourth_down_epa_plus_conversion, join_by(posteam))

colnames(final_chart)[colnames(final_chart) == "total_wins"] <- "Wins"
colnames(final_chart)[colnames(final_chart) == "fourth_down_pct"] <- "FourthDownConversionPercentage"
colnames(final_chart)[colnames(final_chart) == "total_epa"] <- "OffensiveEPA"
  
```

## I messed around with this data a lot. It certainly took a while but I feel like I learned a lot and became more comfortable throughout the process. While the data I found was interesting, I spent too much time looking into stuff that didn't really serve my actual presentation. 